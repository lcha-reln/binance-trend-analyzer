<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∏ÅÂÆâË∂ãÂäøÂàÜÊûê</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            text-align: center;
            padding: 20px 0 30px;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header .time { color: #888; font-size: 14px; }
        .header .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status.loading { background: #f39c12; }
        .status.ok { background: #27ae60; }
        .status.error { background: #e74c3c; }

        .container { max-width: 1400px; margin: 0 auto; }

        .symbols-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
        }

        .symbol-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
        }

        .symbol-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .symbol-name { font-size: 24px; font-weight: bold; }
        .symbol-price { font-size: 28px; font-weight: bold; }
        .price-change { font-size: 16px; margin-left: 10px; }
        .price-change.up { color: #00d4aa; }
        .price-change.down { color: #ff6b6b; }

        .intervals-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .interval-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .interval-name { font-size: 14px; color: #888; margin-bottom: 8px; }
        .interval-direction {
            font-size: 16px;
            font-weight: bold;
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
        }
        .direction-bullish { background: rgba(0,212,170,0.2); color: #00d4aa; }
        .direction-bearish { background: rgba(255,107,107,0.2); color: #ff6b6b; }
        .direction-neutral { background: rgba(255,255,255,0.1); color: #888; }

        .interval-meta { font-size: 12px; color: #666; margin-top: 8px; }
        .interval-score { font-size: 13px; margin-top: 4px; }

        .resonance-box {
            background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2));
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .resonance-title { font-size: 14px; color: #888; margin-bottom: 10px; }
        .resonance-level { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
        .resonance-signal { font-size: 24px; font-weight: bold; }
        .resonance-signal.bullish { color: #00d4aa; }
        .resonance-signal.bearish { color: #ff6b6b; }
        .resonance-signal.neutral { color: #f39c12; }
        .resonance-confidence {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
        }
        .confidence-high { background: #27ae60; }
        .confidence-medium { background: #f39c12; }
        .confidence-low { background: #666; }

        /* ‰∫§ÊòìÂª∫ËÆÆÂç°ÁâáÊ†∑Âºè */
        .advice-box {
            background: linear-gradient(135deg, rgba(30,30,50,0.9), rgba(20,20,40,0.9));
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .advice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .advice-title {
            font-size: 14px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .advice-action {
            font-size: 18px;
            font-weight: bold;
            padding: 6px 16px;
            border-radius: 8px;
        }
        .advice-action.long {
            background: rgba(0,212,170,0.2);
            color: #00d4aa;
            border: 1px solid rgba(0,212,170,0.3);
        }
        .advice-action.short {
            background: rgba(255,107,107,0.2);
            color: #ff6b6b;
            border: 1px solid rgba(255,107,107,0.3);
        }
        .advice-action.wait {
            background: rgba(255,255,255,0.1);
            color: #888;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .advice-reason {
            font-size: 13px;
            color: #aaa;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }
        .advice-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }
        .advice-item {
            background: rgba(255,255,255,0.03);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .advice-item .label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }
        .advice-item .value {
            font-size: 14px;
            font-weight: 600;
        }
        .advice-item .value.bullish { color: #00d4aa; }
        .advice-item .value.bearish { color: #ff6b6b; }
        .advice-item .value.neutral { color: #f39c12; }
        .advice-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .risk-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }
        .risk-badge.low { background: rgba(39,174,96,0.2); color: #27ae60; }
        .risk-badge.medium { background: rgba(243,156,18,0.2); color: #f39c12; }
        .risk-badge.high { background: rgba(231,76,60,0.2); color: #e74c3c; }

        /* Êù†ÊùÜÂª∫ËÆÆÊ†∑Âºè */
        .leverage-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, rgba(243,156,18,0.1), rgba(230,126,34,0.1));
            border: 1px solid rgba(243,156,18,0.2);
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 12px;
        }
        .leverage-icon {
            font-size: 18px;
        }
        .leverage-text {
            flex: 1;
            font-size: 13px;
            color: #f39c12;
        }
        .leverage-badge {
            background: rgba(243,156,18,0.2);
            color: #f39c12;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }
        .advice-tips {
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            padding: 12px;
        }
        .advice-tips .tip-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        .advice-tips ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .advice-tips li {
            font-size: 12px;
            color: #aaa;
            padding: 4px 0;
            padding-left: 16px;
            position: relative;
        }
        .advice-tips li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: #4a90d9;
        }

        /* Âë®ÊúüÂàáÊç¢ Tab Ê†∑Âºè */
        .advice-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        .advice-tab {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            background: rgba(255,255,255,0.05);
            color: #888;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        .advice-tab:hover {
            background: rgba(255,255,255,0.1);
            color: #ccc;
        }
        .advice-tab.active {
            background: rgba(74,144,217,0.2);
            color: #4a90d9;
            border-color: rgba(74,144,217,0.3);
        }

        .footer {
            text-align: center;
            padding: 30px 0;
            color: #666;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .intervals-grid { grid-template-columns: repeat(2, 1fr); }
            .symbols-grid { grid-template-columns: 1fr; }
            .advice-grid { grid-template-columns: repeat(2, 1fr); }
            .advice-meta { flex-direction: column; gap: 8px; align-items: flex-start; }
        }
        @media (max-width: 1024px) and (min-width: 769px) {
            .intervals-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Â∏ÅÂÆâË∂ãÂäøÂàÜÊûê</h1>
            <div>
                <a href="/chart" style="color:#4a90d9; text-decoration:none; margin-right:15px; font-size:14px;">KÁ∫øÂõæË°®</a>
                <span class="time" id="updateTime">Âä†ËΩΩ‰∏≠...</span>
                <span class="status loading" id="status">Âà∑Êñ∞‰∏≠</span>
            </div>
        </div>

        <div class="symbols-grid" id="symbolsContainer">
            <div style="text-align:center; padding: 50px; color: #888;">Âä†ËΩΩÊï∞ÊçÆ‰∏≠...</div>
        </div>

        <div class="footer">
            È£éÈô©ÊèêÁ§∫Ôºö‰ª•‰∏äÂàÜÊûê‰ªÖ‰æõÂèÇËÄÉÔºå‰∏çÊûÑÊàêÊäïËµÑÂª∫ËÆÆÔºåÊäïËµÑÊúâÈ£éÈô©ÔºåÂÖ•Â∏ÇÈúÄË∞®ÊÖéÔºÅ
        </div>
    </div>

    <script>
        const refreshInterval = {{ refresh_interval }} * 1000;

        function getDirectionClass(direction) {
            if (direction.includes('Ê∂®') || direction.includes('Â§ö')) return 'bullish';
            if (direction.includes('Ë∑å') || direction.includes('Á©∫')) return 'bearish';
            return 'neutral';
        }

        function getConfidenceClass(confidence) {
            if (['ÊûÅÈ´ò', 'È´ò', '‰∏≠È´ò'].includes(confidence)) return 'high';
            if (confidence === '‰∏≠') return 'medium';
            return 'low';
        }

        function intervalToMinutes(interval) {
            const num = parseInt(interval);
            if (interval.endsWith('m')) return num;
            if (interval.endsWith('h')) return num * 60;
            if (interval.endsWith('d')) return num * 60 * 24;
            if (interval.endsWith('w')) return num * 60 * 24 * 7;
            return num;
        }

        function sortIntervals(intervals) {
            return Object.entries(intervals).sort((a, b) =>
                intervalToMinutes(a[0]) - intervalToMinutes(b[0])
            );
        }

        function formatPrice(price) {
            return price >= 1000 ? price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})
                                 : price.toFixed(4);
        }

        function getRiskClass(riskLevel) {
            if (riskLevel === '‰Ωé' || riskLevel === '‰∏≠‰Ωé') return 'low';
            if (riskLevel === 'È´ò' || riskLevel === '‰∏≠È´ò') return 'high';
            return 'medium';
        }

        function renderAdviceBox(advice, interval) {
            if (!advice) return '';

            const actionClass = advice.action_en || 'wait';
            const isOpen = actionClass !== 'wait';

            let priceGridHtml = '';
            if (isOpen && advice.stop_loss) {
                const slClass = actionClass === 'long' ? 'bearish' : 'bullish';
                const tp1Class = actionClass === 'long' ? 'bullish' : 'bearish';

                priceGridHtml = `
                    <div class="advice-grid">
                        <div class="advice-item">
                            <div class="label">Ê≠¢Êçü‰ª∑</div>
                            <div class="value ${slClass}">$${formatPrice(advice.stop_loss)}</div>
                        </div>
                        <div class="advice-item">
                            <div class="label">Ê≠¢Áõà1 (30%)</div>
                            <div class="value ${tp1Class}">$${formatPrice(advice.take_profit_1)}</div>
                        </div>
                        <div class="advice-item">
                            <div class="label">Ê≠¢Áõà2 (40%)</div>
                            <div class="value ${tp1Class}">$${formatPrice(advice.take_profit_2)}</div>
                        </div>
                        <div class="advice-item">
                            <div class="label">Ê≠¢Áõà3 (30%)</div>
                            <div class="value ${tp1Class}">$${formatPrice(advice.take_profit_3)}</div>
                        </div>
                    </div>
                `;
            }

            const tipsHtml = advice.key_points && advice.key_points.length > 0
                ? `<div class="advice-tips">
                       <div class="tip-title">ÂÖ≥ÈîÆÊèêÁ§∫</div>
                       <ul>${advice.key_points.map(tip => `<li>${tip}</li>`).join('')}</ul>
                   </div>`
                : '';

            const leverageHtml = isOpen && advice.max_leverage
                ? `<div class="leverage-box">
                       <span class="leverage-icon">‚ö°</span>
                       <span class="leverage-text">${advice.leverage_suggestion}</span>
                       <span class="leverage-badge">${advice.safe_leverage}x - ${advice.max_leverage}x</span>
                   </div>`
                : '';

            const metaHtml = isOpen
                ? `<div class="advice-meta">
                       <span>‰ªì‰Ωç: ${advice.position_suggestion || '-'}</span>
                       <span>È£éÈô©Êî∂ÁõäÊØî: ${advice.risk_reward_ratio || '-'}</span>
                       <span class="risk-badge ${getRiskClass(advice.risk_level)}">È£éÈô©: ${advice.risk_level}</span>
                   </div>
                   ${leverageHtml}`
                : '';

            return `
                <div class="advice-box">
                    <div class="advice-header">
                        <span class="advice-title">üìä ${interval} ‰∫§ÊòìÂª∫ËÆÆ</span>
                        <span class="advice-action ${actionClass}">${advice.action}</span>
                    </div>
                    <div class="advice-reason">${advice.reason || 'ÊöÇÊó†Âª∫ËÆÆ'}</div>
                    ${priceGridHtml}
                    ${metaHtml}
                    ${tipsHtml}
                </div>
            `;
        }

        function renderData(data) {
            const container = document.getElementById('symbolsContainer');
            let html = '';

            for (const [symbol, symbolData] of Object.entries(data.symbols)) {
                const firstInterval = Object.values(symbolData.intervals)[0];
                const price = firstInterval.current_price;
                const change = firstInterval.stats_24h?.price_change_percent || 0;
                const changeClass = change >= 0 ? 'up' : 'down';
                const changeSign = change >= 0 ? '+' : '';

                html += `
                    <div class="symbol-card">
                        <div class="symbol-header">
                            <span class="symbol-name">${symbol.replace('USDT', '/USDT')}</span>
                            <div>
                                <span class="symbol-price">$${formatPrice(price)}</span>
                                <span class="price-change ${changeClass}">${changeSign}${change.toFixed(2)}%</span>
                            </div>
                        </div>

                        <div class="intervals-grid">
                `;

                for (const [interval, iData] of sortIntervals(symbolData.intervals)) {
                    const pred = iData.prediction;
                    const dirClass = getDirectionClass(pred.direction);
                    html += `
                        <div class="interval-card">
                            <div class="interval-name">${interval}</div>
                            <div class="interval-direction direction-${dirClass}">${pred.direction}</div>
                            <div class="interval-score">ËØÑÂàÜ: ${pred.score} (${pred.volume_weight.toFixed(1)}x)</div>
                            <div class="interval-meta">ÁΩÆ‰ø°Â∫¶: ${pred.confidence}</div>
                        </div>
                    `;
                }

                const res = symbolData.resonance;
                const resClass = getDirectionClass(res.signal);
                const confClass = getConfidenceClass(res.confidence);

                html += `
                        </div>
                        <div class="resonance-box">
                            <div class="resonance-title">Â§öÂë®ÊúüÂÖ±ÊåØÂàÜÊûê</div>
                            <div class="resonance-level">${res.resonance_level}</div>
                            <div class="resonance-signal ${resClass}">${res.signal}</div>
                            <div><span class="resonance-confidence confidence-${confClass}">ÁΩÆ‰ø°Â∫¶: ${res.confidence}</span></div>
                        </div>
                `;

                // ÊòæÁ§∫Âë®ÊúüÂàáÊç¢TabÂíå‰∫§ÊòìÂª∫ËÆÆ
                const adviceIntervals = ['5m', '30m', '1h', '4h', '1d'];
                const symbolId = symbol.replace(/[^a-zA-Z0-9]/g, '');

                html += `<div class="advice-tabs">`;
                for (const intv of adviceIntervals) {
                    const hasAdvice = symbolData.intervals[intv]?.trading_advice;
                    const activeClass = intv === '1h' ? 'active' : '';
                    const disabledStyle = hasAdvice ? '' : 'opacity: 0.4; pointer-events: none;';
                    html += `<span class="advice-tab ${activeClass}" style="${disabledStyle}"
                                   data-symbol="${symbolId}" data-interval="${intv}">${intv}</span>`;
                }
                html += `</div>`;

                // Ê∏≤ÊüìÊâÄÊúâÂë®ÊúüÁöÑÂª∫ËÆÆÔºåÈªòËÆ§Âè™ÊòæÁ§∫1h
                for (const intv of adviceIntervals) {
                    const intvData = symbolData.intervals[intv];
                    if (intvData && intvData.trading_advice) {
                        const displayStyle = intv === '1h' ? '' : 'display: none;';
                        html += `<div class="advice-content" data-symbol="${symbolId}" data-interval="${intv}" style="${displayStyle}">`;
                        html += renderAdviceBox(intvData.trading_advice, intv);
                        html += `</div>`;
                    }
                }

                // ÂÖ≥Èó≠ symbol-card div
                html += `</div>`;
            }

            container.innerHTML = html;

            // ÁªëÂÆöTabÂàáÊç¢‰∫ã‰ª∂
            bindAdviceTabs();
        }

        function bindAdviceTabs() {
            document.querySelectorAll('.advice-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const symbol = this.dataset.symbol;
                    const interval = this.dataset.interval;

                    // ÂàáÊç¢Tab activeÁä∂ÊÄÅ
                    document.querySelectorAll(`.advice-tab[data-symbol="${symbol}"]`).forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');

                    // ÂàáÊç¢ÂÜÖÂÆπÊòæÁ§∫
                    document.querySelectorAll(`.advice-content[data-symbol="${symbol}"]`).forEach(content => {
                        content.style.display = content.dataset.interval === interval ? '' : 'none';
                    });
                });
            });
        }

        async function fetchData() {
            const status = document.getElementById('status');
            status.textContent = 'Âà∑Êñ∞‰∏≠';
            status.className = 'status loading';

            try {
                const response = await fetch('/api/analysis');
                const result = await response.json();

                if (result.success) {
                    renderData(result.data);
                    document.getElementById('updateTime').textContent = 'Êõ¥Êñ∞‰∫é ' + result.data.timestamp;
                    status.textContent = 'Ê≠£Â∏∏';
                    status.className = 'status ok';
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                status.textContent = 'ÈîôËØØ';
                status.className = 'status error';
                console.error('Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        fetchData();
        setInterval(fetchData, refreshInterval);
    </script>
</body>
</html>
