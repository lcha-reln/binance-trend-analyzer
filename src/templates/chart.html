<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kçº¿å›¾è¡¨ - å¸å®‰è¶‹åŠ¿åˆ†æ</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header h1 {
            font-size: 20px;
            font-weight: 500;
        }
        .header a {
            color: #888;
            text-decoration: none;
            font-size: 14px;
        }
        .header a:hover { color: #fff; }

        .controls {
            display: flex;
            gap: 15px;
            padding: 15px 20px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .control-group label {
            font-size: 13px;
            color: #888;
        }
        select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        select:focus { outline: none; border-color: #4a90d9; }

        .toggle-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #888;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-btn.active {
            background: rgba(74,144,217,0.3);
            border-color: #4a90d9;
            color: #fff;
        }
        .toggle-btn:hover { border-color: #4a90d9; }

        .chart-container {
            display: flex;
            height: calc(100vh - 130px);
        }
        #chart {
            flex: 1;
        }

        .info-panel {
            width: 280px;
            background: rgba(255,255,255,0.03);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 15px;
            overflow-y: auto;
        }
        .info-section {
            margin-bottom: 20px;
        }
        .info-section h3 {
            font-size: 13px;
            color: #888;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
        }
        .info-item .label { color: #888; }
        .info-item .value { font-weight: 500; }
        .bullish { color: #00d4aa; }
        .bearish { color: #ff6b6b; }
        .neutral { color: #888; }

        .pattern-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
            cursor: help;
            position: relative;
        }
        .pattern-tag.bullish { background: rgba(0,212,170,0.2); color: #00d4aa; }
        .pattern-tag.bearish { background: rgba(255,107,107,0.2); color: #ff6b6b; }
        .pattern-tag.neutral { background: rgba(255,255,255,0.1); color: #888; }

        /* æ‚¬æµ®æç¤ºå¡ç‰‡ */
        .pattern-tooltip {
            position: fixed;
            background: linear-gradient(135deg, #2a2a4a 0%, #1e1e3a 100%);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 14px 16px;
            min-width: 240px;
            max-width: 300px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transform: translateY(5px);
            transition: opacity 0.2s, transform 0.2s;
        }
        .pattern-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .pattern-tooltip .tooltip-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .pattern-tooltip .tooltip-icon {
            font-size: 18px;
        }
        .pattern-tooltip .tooltip-title {
            font-size: 14px;
            font-weight: 600;
        }
        .pattern-tooltip .tooltip-type {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: auto;
        }
        .pattern-tooltip .tooltip-type.bullish {
            background: rgba(0,212,170,0.2);
            color: #00d4aa;
        }
        .pattern-tooltip .tooltip-type.bearish {
            background: rgba(255,107,107,0.2);
            color: #ff6b6b;
        }
        .pattern-tooltip .tooltip-desc {
            font-size: 13px;
            line-height: 1.5;
            color: #ccc;
            margin-bottom: 10px;
        }
        .pattern-tooltip .tooltip-signal {
            font-size: 12px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .pattern-tooltip .tooltip-signal::before {
            content: 'ğŸ’¡';
        }

        .level-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            margin: 3px 0;
            border-radius: 4px;
            font-size: 12px;
        }
        .level-item.support { background: rgba(0,212,170,0.1); }
        .level-item.resistance { background: rgba(255,107,107,0.1); }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #888;
        }

        @media (max-width: 900px) {
            .chart-container { flex-direction: column; }
            .info-panel { width: 100%; height: 200px; border-left: none; border-top: 1px solid rgba(255,255,255,0.1); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Kçº¿å›¾è¡¨åˆ†æ</h1>
        <a href="/">è¿”å›è¶‹åŠ¿é¢æ¿</a>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>äº¤æ˜“å¯¹:</label>
            <select id="symbolSelect">
                {% for symbol in symbols %}
                <option value="{{ symbol }}">{{ symbol }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="control-group">
            <label>å‘¨æœŸ:</label>
            <select id="intervalSelect">
                {% for interval in intervals %}
                <option value="{{ interval }}">{{ interval }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="control-group">
            <button class="toggle-btn active" data-indicator="ma">MA</button>
            <button class="toggle-btn" data-indicator="boll">å¸ƒæ—å¸¦</button>
            <button class="toggle-btn active" data-indicator="volume">æˆäº¤é‡</button>
            <button class="toggle-btn active" data-indicator="patterns">å½¢æ€æ ‡è®°</button>
            <button class="toggle-btn active" data-indicator="sr">æ”¯æ’‘é˜»åŠ›</button>
        </div>
    </div>

    <!-- æ‚¬æµ®æç¤ºå¡ç‰‡ -->
    <div class="pattern-tooltip" id="patternTooltip"></div>

    <div class="chart-container">
        <div id="chart">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        <div class="info-panel">
            <div class="info-section">
                <h3>å½“å‰ä¿¡æ¯</h3>
                <div class="info-item">
                    <span class="label">ä»·æ ¼</span>
                    <span class="value" id="currentPrice">-</span>
                </div>
                <div class="info-item">
                    <span class="label">24hæ¶¨è·Œ</span>
                    <span class="value" id="priceChange">-</span>
                </div>
            </div>

            <div class="info-section">
                <h3>Kçº¿å½¢æ€</h3>
                <div id="patternsList">-</div>
            </div>

            <div class="info-section">
                <h3>æ”¯æ’‘ä½</h3>
                <div id="supportsList">-</div>
            </div>

            <div class="info-section">
                <h3>é˜»åŠ›ä½</h3>
                <div id="resistancesList">-</div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let candlestickSeries = null;
        let volumeSeries = null;
        let maSeries = { ma7: null, ma25: null, ma99: null };
        let bollSeries = { upper: null, middle: null, lower: null };
        let srLines = [];
        let markers = [];

        const indicators = {
            ma: true,
            boll: false,
            volume: true,
            patterns: true,
            sr: true
        };

        // Kçº¿å½¢æ€è¯´æ˜å­—å…¸
        const patternDescriptions = {
            'é”¤å­çº¿': {
                icon: 'ğŸ”¨',
                type: 'bullish',
                typeName: 'çœ‹æ¶¨åè½¬',
                desc: 'ä¸‹å½±çº¿å¾ˆé•¿ï¼ˆè‡³å°‘ä¸ºå®ä½“çš„2å€ï¼‰ï¼Œä¸Šå½±çº¿å¾ˆçŸ­æˆ–æ²¡æœ‰ã€‚å‡ºç°åœ¨ä¸‹è·Œè¶‹åŠ¿æœ«ç«¯ï¼Œè¡¨ç¤ºä¹°æ–¹å¼€å§‹å…¥åœºã€‚',
                signal: 'è€ƒè™‘åœ¨ç¡®è®¤ååšå¤šï¼Œæ­¢æŸè®¾åœ¨é”¤å­çº¿ä½ç‚¹ä¸‹æ–¹'
            },
            'å€’é”¤å­çº¿': {
                icon: 'ğŸ”¨',
                type: 'bullish',
                typeName: 'çœ‹æ¶¨åè½¬',
                desc: 'ä¸Šå½±çº¿å¾ˆé•¿ï¼ˆè‡³å°‘ä¸ºå®ä½“çš„2å€ï¼‰ï¼Œä¸‹å½±çº¿å¾ˆçŸ­æˆ–æ²¡æœ‰ã€‚å‡ºç°åœ¨ä¸‹è·Œè¶‹åŠ¿æœ«ç«¯ï¼Œè¡¨ç¤ºç©ºå¤´åŠ›é‡è¡°ç«­ã€‚',
                signal: 'éœ€è¦ä¸‹ä¸€æ ¹é˜³çº¿ç¡®è®¤ï¼Œä¹‹åå¯è€ƒè™‘åšå¤š'
            },
            'ä¸ŠåŠçº¿': {
                icon: 'â˜ ï¸',
                type: 'bearish',
                typeName: 'çœ‹è·Œåè½¬',
                desc: 'å½¢æ€ä¸é”¤å­çº¿ç›¸åŒï¼Œä½†å‡ºç°åœ¨ä¸Šæ¶¨è¶‹åŠ¿é¡¶éƒ¨ã€‚è¡¨ç¤ºå–å‹å¼€å§‹å¢åŠ ï¼Œä¹°æ–¹åŠ›é‡å‡å¼±ã€‚',
                signal: 'è­¦æƒ•è¶‹åŠ¿åè½¬ï¼Œè€ƒè™‘å‡ä»“æˆ–æ­¢ç›ˆ'
            },
            'å°„å‡»ä¹‹æ˜Ÿ': {
                icon: 'â­',
                type: 'bearish',
                typeName: 'çœ‹è·Œåè½¬',
                desc: 'ä¸Šå½±çº¿å¾ˆé•¿ï¼Œå®ä½“å°ï¼Œä¸‹å½±çº¿å¾ˆçŸ­ã€‚å‡ºç°åœ¨ä¸Šæ¶¨è¶‹åŠ¿é¡¶éƒ¨ï¼Œè¡¨ç¤ºä»·æ ¼å†²é«˜åé­åˆ°æŠ›å”®ã€‚',
                signal: 'å¼ºçƒˆçš„é¡¶éƒ¨ä¿¡å·ï¼Œè€ƒè™‘åšç©ºæˆ–æ­¢ç›ˆ'
            },
            'åå­—æ˜Ÿ': {
                icon: 'âœš',
                type: 'neutral',
                typeName: 'çŠ¹è±«ä¿¡å·',
                desc: 'å¼€ç›˜ä»·ä¸æ”¶ç›˜ä»·å‡ ä¹ç›¸ç­‰ï¼Œå½¢æˆåå­—å½¢ã€‚è¡¨ç¤ºå¤šç©ºåŒæ–¹åŠ›é‡å‡è¡¡ï¼Œå¸‚åœºçŠ¹è±«ä¸å†³ã€‚',
                signal: 'å…³æ³¨åç»­Kçº¿æ–¹å‘ï¼Œå¯èƒ½é¢„ç¤ºè¶‹åŠ¿è½¬å˜'
            },
            'é•¿è…¿åå­—æ˜Ÿ': {
                icon: 'âœš',
                type: 'neutral',
                typeName: 'å¼ºçŠ¹è±«ä¿¡å·',
                desc: 'ä¸Šä¸‹å½±çº¿éƒ½å¾ˆé•¿çš„åå­—æ˜Ÿã€‚è¡¨ç¤ºç›˜ä¸­å‰§çƒˆæ³¢åŠ¨ï¼Œä½†æœ€ç»ˆå¤šç©ºå¹³è¡¡ï¼Œå¸‚åœºæ–¹å‘ä¸æ˜ã€‚',
                signal: 'é«˜åº¦ä¸ç¡®å®šæ€§ï¼Œç­‰å¾…æ˜ç¡®æ–¹å‘å†æ“ä½œ'
            },
            'èœ»èœ“åå­—æ˜Ÿ': {
                icon: 'ğŸª°',
                type: 'bullish',
                typeName: 'æ½œåœ¨çœ‹æ¶¨',
                desc: 'åªæœ‰ä¸‹å½±çº¿çš„åå­—æ˜Ÿï¼ˆTå­—å½¢ï¼‰ã€‚è¡¨ç¤ºä»·æ ¼ä¸‹æ¢åè¢«æ‹‰å›ï¼Œä¹°æ–¹åŠ›é‡è¾ƒå¼ºã€‚',
                signal: 'å‡ºç°åœ¨åº•éƒ¨æ—¶çœ‹æ¶¨ä¿¡å·è¾ƒå¼º'
            },
            'å¢“ç¢‘åå­—æ˜Ÿ': {
                icon: 'ğŸª¦',
                type: 'bearish',
                typeName: 'æ½œåœ¨çœ‹è·Œ',
                desc: 'åªæœ‰ä¸Šå½±çº¿çš„åå­—æ˜Ÿï¼ˆå€’Tå­—å½¢ï¼‰ã€‚è¡¨ç¤ºä»·æ ¼å†²é«˜åè¢«æ‰“å‹ï¼Œå–æ–¹åŠ›é‡è¾ƒå¼ºã€‚',
                signal: 'å‡ºç°åœ¨é¡¶éƒ¨æ—¶çœ‹è·Œä¿¡å·è¾ƒå¼º'
            },
            'çœ‹æ¶¨åæ²¡': {
                icon: 'ğŸŸ¢',
                type: 'bullish',
                typeName: 'å¼ºçœ‹æ¶¨åè½¬',
                desc: 'å¤§é˜³çº¿å®Œå…¨åæ²¡å‰ä¸€æ ¹é˜´çº¿çš„å®ä½“ã€‚è¡¨ç¤ºä¹°æ–¹åŠ›é‡å¼ºåŠ¿æ¥ç®¡ï¼Œæ˜¯å¼ºçƒˆçš„åè½¬ä¿¡å·ã€‚',
                signal: 'é‡è¦çš„åº•éƒ¨åè½¬ä¿¡å·ï¼Œå¯åœ¨ç¡®è®¤åç§¯æåšå¤š'
            },
            'çœ‹è·Œåæ²¡': {
                icon: 'ğŸ”´',
                type: 'bearish',
                typeName: 'å¼ºçœ‹è·Œåè½¬',
                desc: 'å¤§é˜´çº¿å®Œå…¨åæ²¡å‰ä¸€æ ¹é˜³çº¿çš„å®ä½“ã€‚è¡¨ç¤ºå–æ–¹åŠ›é‡å¼ºåŠ¿æ¥ç®¡ï¼Œæ˜¯å¼ºçƒˆçš„åè½¬ä¿¡å·ã€‚',
                signal: 'é‡è¦çš„é¡¶éƒ¨åè½¬ä¿¡å·ï¼Œåº”è€ƒè™‘æ­¢ç›ˆæˆ–åšç©º'
            },
            'ä¹Œäº‘ç›–é¡¶': {
                icon: 'â˜ï¸',
                type: 'bearish',
                typeName: 'çœ‹è·Œåè½¬',
                desc: 'é˜´çº¿å¼€ç›˜é«˜äºå‰é˜³çº¿æœ€é«˜ä»·ï¼Œæ”¶ç›˜æ·±å…¥å‰é˜³çº¿å®ä½“ä¸­éƒ¨ä»¥ä¸‹ã€‚è¡¨ç¤ºä¸Šæ¶¨åŠ¨èƒ½å‡å¼±ã€‚',
                signal: 'é¡¶éƒ¨è­¦å‘Šä¿¡å·ï¼Œè€ƒè™‘å‡ä»“'
            },
            'åˆºé€å½¢æ€': {
                icon: 'ğŸ—¡ï¸',
                type: 'bullish',
                typeName: 'çœ‹æ¶¨åè½¬',
                desc: 'é˜³çº¿å¼€ç›˜ä½äºå‰é˜´çº¿æœ€ä½ä»·ï¼Œæ”¶ç›˜çªç ´å‰é˜´çº¿å®ä½“ä¸­éƒ¨ä»¥ä¸Šã€‚è¡¨ç¤ºä¸‹è·ŒåŠ¨èƒ½å‡å¼±ã€‚',
                signal: 'åº•éƒ¨åè½¬ä¿¡å·ï¼Œå¯è€ƒè™‘è¯•æ¢æ€§åšå¤š'
            },
            'æ—©æ™¨ä¹‹æ˜Ÿ': {
                icon: 'ğŸŒ…',
                type: 'bullish',
                typeName: 'å¼ºçœ‹æ¶¨åè½¬',
                desc: 'ä¸‰æ ¹Kçº¿ç»„åˆï¼šå¤§é˜´çº¿ + å°å®ä½“ï¼ˆç¼ºå£å‘ä¸‹ï¼‰+ å¤§é˜³çº¿ã€‚æ˜¯ç»å…¸çš„åº•éƒ¨åè½¬å½¢æ€ã€‚',
                signal: 'å¯é çš„åšå¤šä¿¡å·ï¼Œå°¤å…¶åœ¨é‡è¦æ”¯æ’‘ä½é™„è¿‘'
            },
            'é»„æ˜ä¹‹æ˜Ÿ': {
                icon: 'ğŸŒ†',
                type: 'bearish',
                typeName: 'å¼ºçœ‹è·Œåè½¬',
                desc: 'ä¸‰æ ¹Kçº¿ç»„åˆï¼šå¤§é˜³çº¿ + å°å®ä½“ï¼ˆç¼ºå£å‘ä¸Šï¼‰+ å¤§é˜´çº¿ã€‚æ˜¯ç»å…¸çš„é¡¶éƒ¨åè½¬å½¢æ€ã€‚',
                signal: 'å¯é çš„å–å‡ºä¿¡å·ï¼Œå°¤å…¶åœ¨é‡è¦é˜»åŠ›ä½é™„è¿‘'
            },
            'ä¸‰åªç™½å…µ': {
                icon: 'ğŸ“ˆ',
                type: 'bullish',
                typeName: 'è¶‹åŠ¿ç¡®è®¤',
                desc: 'è¿ç»­ä¸‰æ ¹é˜³çº¿ï¼Œæ¯æ ¹éƒ½åˆ›æ–°é«˜ä¸”æ”¶ç›˜åœ¨é«˜ä½é™„è¿‘ã€‚è¡¨ç¤ºå¼ºåŠ²çš„ä¸Šæ¶¨åŠ¨èƒ½ã€‚',
                signal: 'è¶‹åŠ¿å»¶ç»­ä¿¡å·ï¼Œå¯é¡ºåŠ¿åšå¤š'
            },
            'ä¸‰åªé»‘é¸¦': {
                icon: 'ğŸ“‰',
                type: 'bearish',
                typeName: 'è¶‹åŠ¿ç¡®è®¤',
                desc: 'è¿ç»­ä¸‰æ ¹é˜´çº¿ï¼Œæ¯æ ¹éƒ½åˆ›æ–°ä½ä¸”æ”¶ç›˜åœ¨ä½ä½é™„è¿‘ã€‚è¡¨ç¤ºå¼ºåŠ²çš„ä¸‹è·ŒåŠ¨èƒ½ã€‚',
                signal: 'è¶‹åŠ¿å»¶ç»­ä¿¡å·ï¼Œåº”å›é¿åšå¤š'
            },
            'å¤§é˜³çº¿': {
                icon: 'ğŸŸ©',
                type: 'bullish',
                typeName: 'å¼ºåŠ¿ä¿¡å·',
                desc: 'å®ä½“å¾ˆé•¿çš„é˜³çº¿ï¼Œè¡¨ç¤ºä¹°æ–¹å®Œå…¨ä¸»å¯¼å¸‚åœºï¼Œä»·æ ¼å¤§å¹…ä¸Šæ¶¨ã€‚',
                signal: 'å¼ºåŠ¿ä¸Šæ¶¨ä¿¡å·ï¼Œä½†æ³¨æ„è¿½é«˜é£é™©'
            },
            'å¤§é˜´çº¿': {
                icon: 'ğŸŸ¥',
                type: 'bearish',
                typeName: 'å¼±åŠ¿ä¿¡å·',
                desc: 'å®ä½“å¾ˆé•¿çš„é˜´çº¿ï¼Œè¡¨ç¤ºå–æ–¹å®Œå…¨ä¸»å¯¼å¸‚åœºï¼Œä»·æ ¼å¤§å¹…ä¸‹è·Œã€‚',
                signal: 'å¼ºåŠ¿ä¸‹è·Œä¿¡å·ï¼Œå›é¿åšå¤š'
            }
        };

        // æç¤ºå¡ç‰‡é€»è¾‘
        const tooltip = document.getElementById('patternTooltip');
        let tooltipTimeout = null;

        function showTooltip(patternName, event) {
            const info = patternDescriptions[patternName];
            if (!info) return;

            tooltip.innerHTML = `
                <div class="tooltip-header">
                    <span class="tooltip-icon">${info.icon}</span>
                    <span class="tooltip-title">${patternName}</span>
                    <span class="tooltip-type ${info.type}">${info.typeName}</span>
                </div>
                <div class="tooltip-desc">${info.desc}</div>
                <div class="tooltip-signal">${info.signal}</div>
            `;

            // è®¡ç®—ä½ç½®
            const rect = event.target.getBoundingClientRect();
            let left = rect.left;
            let top = rect.bottom + 8;

            // é˜²æ­¢è¶…å‡ºå±å¹•å³è¾¹
            if (left + 300 > window.innerWidth) {
                left = window.innerWidth - 310;
            }
            // é˜²æ­¢è¶…å‡ºå±å¹•åº•éƒ¨
            if (top + 200 > window.innerHeight) {
                top = rect.top - 180;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            tooltip.classList.remove('visible');
        }

        function attachTooltipEvents() {
            document.querySelectorAll('.pattern-tag').forEach(tag => {
                tag.addEventListener('mouseenter', (e) => {
                    if (tooltipTimeout) clearTimeout(tooltipTimeout);
                    showTooltip(tag.textContent.trim(), e);
                });
                tag.addEventListener('mouseleave', () => {
                    tooltipTimeout = setTimeout(hideTooltip, 100);
                });
            });
        }

        function initChart() {
            const container = document.getElementById('chart');
            container.innerHTML = '';

            chart = LightweightCharts.createChart(container, {
                layout: {
                    background: { color: '#1a1a2e' },
                    textColor: '#888',
                },
                grid: {
                    vertLines: { color: 'rgba(255,255,255,0.05)' },
                    horzLines: { color: 'rgba(255,255,255,0.05)' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: 'rgba(255,255,255,0.1)',
                },
                timeScale: {
                    borderColor: 'rgba(255,255,255,0.1)',
                    timeVisible: true,
                },
            });

            // Kçº¿
            candlestickSeries = chart.addCandlestickSeries({
                upColor: '#00d4aa',
                downColor: '#ff6b6b',
                borderUpColor: '#00d4aa',
                borderDownColor: '#ff6b6b',
                wickUpColor: '#00d4aa',
                wickDownColor: '#ff6b6b',
            });

            // æˆäº¤é‡
            volumeSeries = chart.addHistogramSeries({
                color: '#4a90d9',
                priceFormat: { type: 'volume' },
                priceScaleId: '',
                scaleMargins: { top: 0.85, bottom: 0 },
            });

            // MAçº¿
            maSeries.ma7 = chart.addLineSeries({ color: '#f0b90b', lineWidth: 1, title: 'MA7' });
            maSeries.ma25 = chart.addLineSeries({ color: '#e91e63', lineWidth: 1, title: 'MA25' });
            maSeries.ma99 = chart.addLineSeries({ color: '#9c27b0', lineWidth: 1, title: 'MA99' });

            // å¸ƒæ—å¸¦
            bollSeries.upper = chart.addLineSeries({ color: 'rgba(76,175,80,0.5)', lineWidth: 1 });
            bollSeries.middle = chart.addLineSeries({ color: 'rgba(76,175,80,0.8)', lineWidth: 1 });
            bollSeries.lower = chart.addLineSeries({ color: 'rgba(76,175,80,0.5)', lineWidth: 1 });

            chart.timeScale().fitContent();
        }

        async function loadData() {
            const symbol = document.getElementById('symbolSelect').value;
            const interval = document.getElementById('intervalSelect').value;

            try {
                const response = await fetch(`/api/klines?symbol=${symbol}&interval=${interval}&limit=200`);
                const result = await response.json();

                if (!result.success) {
                    console.error('åŠ è½½å¤±è´¥:', result.error);
                    return;
                }

                const data = result.data;

                // è®¾ç½®Kçº¿æ•°æ®
                candlestickSeries.setData(data.klines);

                // è®¾ç½®æˆäº¤é‡
                const volumeData = data.klines.map(k => ({
                    time: k.time,
                    value: k.volume,
                    color: k.close >= k.open ? 'rgba(0,212,170,0.5)' : 'rgba(255,107,107,0.5)'
                }));
                volumeSeries.setData(volumeData);

                // è®¾ç½®MA
                maSeries.ma7.setData(data.ma.ma7);
                maSeries.ma25.setData(data.ma.ma25);
                maSeries.ma99.setData(data.ma.ma99);

                // è®¾ç½®å¸ƒæ—å¸¦
                bollSeries.upper.setData(data.boll.upper);
                bollSeries.middle.setData(data.boll.middle);
                bollSeries.lower.setData(data.boll.lower);

                // å½¢æ€æ ‡è®°
                markers = data.patterns.map(p => ({
                    time: p.time,
                    position: p.type === 'bearish' ? 'aboveBar' : 'belowBar',
                    color: p.type === 'bullish' ? '#00d4aa' : (p.type === 'bearish' ? '#ff6b6b' : '#888'),
                    shape: p.type === 'bullish' ? 'arrowUp' : 'arrowDown',
                    text: p.pattern.split(',')[0]
                }));
                if (indicators.patterns) {
                    candlestickSeries.setMarkers(markers);
                }

                // æ›´æ–°æ”¯æ’‘é˜»åŠ›ä½æ˜¾ç¤º
                updateSRLines(data.support_resistance);

                // æ›´æ–°ä¿¡æ¯é¢æ¿
                updateInfoPanel(data);

                // æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
                updateIndicatorVisibility();

                chart.timeScale().fitContent();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å‡ºé”™:', error);
            }
        }

        function updateSRLines(sr) {
            // æ¸…é™¤æ—§çº¿
            srLines.forEach(line => {
                try { chart.removePriceLine(line); } catch(e) {}
            });
            srLines = [];

            if (!indicators.sr) return;

            const currentPrice = candlestickSeries.data && candlestickSeries.data().length > 0
                ? candlestickSeries.data()[candlestickSeries.data().length - 1].close
                : null;

            // ç»˜åˆ¶æ”¯æ’‘ä½
            if (sr.supports) {
                sr.supports.forEach(price => {
                    const line = candlestickSeries.createPriceLine({
                        price: price,
                        color: '#00d4aa',
                        lineWidth: 1,
                        lineStyle: LightweightCharts.LineStyle.Dashed,
                        axisLabelVisible: true,
                        title: 'æ”¯æ’‘',
                    });
                    srLines.push(line);
                });
            }

            // ç»˜åˆ¶é˜»åŠ›ä½
            if (sr.resistances) {
                sr.resistances.forEach(price => {
                    const line = candlestickSeries.createPriceLine({
                        price: price,
                        color: '#ff6b6b',
                        lineWidth: 1,
                        lineStyle: LightweightCharts.LineStyle.Dashed,
                        axisLabelVisible: true,
                        title: 'é˜»åŠ›',
                    });
                    srLines.push(line);
                });
            }
        }

        function updateInfoPanel(data) {
            const klines = data.klines;
            if (klines.length > 0) {
                const latest = klines[klines.length - 1];
                document.getElementById('currentPrice').textContent = '$' + latest.close.toLocaleString();
            }

            // å½¢æ€åˆ—è¡¨
            const patternsList = document.getElementById('patternsList');
            if (data.patterns.length > 0) {
                const recentPatterns = data.patterns.slice(-5);
                patternsList.innerHTML = recentPatterns.map(p =>
                    `<span class="pattern-tag ${p.type}">${p.pattern}</span>`
                ).join('');
                // ç»‘å®šæ‚¬æµ®æç¤ºäº‹ä»¶
                attachTooltipEvents();
            } else {
                patternsList.innerHTML = '<span class="neutral">æš‚æ— å½¢æ€</span>';
            }

            // æ”¯æ’‘ä½åˆ—è¡¨
            const supportsList = document.getElementById('supportsList');
            const sr = data.support_resistance;
            if (sr.supports && sr.supports.length > 0) {
                supportsList.innerHTML = sr.supports.map(s =>
                    `<div class="level-item support"><span>$${s.toLocaleString()}</span></div>`
                ).join('');
            } else {
                supportsList.innerHTML = '<span class="neutral">æš‚æ— </span>';
            }

            // é˜»åŠ›ä½åˆ—è¡¨
            const resistancesList = document.getElementById('resistancesList');
            if (sr.resistances && sr.resistances.length > 0) {
                resistancesList.innerHTML = sr.resistances.map(r =>
                    `<div class="level-item resistance"><span>$${r.toLocaleString()}</span></div>`
                ).join('');
            } else {
                resistancesList.innerHTML = '<span class="neutral">æš‚æ— </span>';
            }
        }

        function updateIndicatorVisibility() {
            // MA
            Object.values(maSeries).forEach(s => s.applyOptions({ visible: indicators.ma }));

            // å¸ƒæ—å¸¦
            Object.values(bollSeries).forEach(s => s.applyOptions({ visible: indicators.boll }));

            // æˆäº¤é‡
            volumeSeries.applyOptions({ visible: indicators.volume });

            // å½¢æ€æ ‡è®°
            if (indicators.patterns) {
                candlestickSeries.setMarkers(markers);
            } else {
                candlestickSeries.setMarkers([]);
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('symbolSelect').addEventListener('change', loadData);
        document.getElementById('intervalSelect').addEventListener('change', loadData);

        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const indicator = btn.dataset.indicator;
                indicators[indicator] = !indicators[indicator];
                btn.classList.toggle('active');

                if (indicator === 'sr') {
                    // é‡æ–°åŠ è½½æ”¯æ’‘é˜»åŠ›çº¿
                    loadData();
                } else {
                    updateIndicatorVisibility();
                }
            });
        });

        // åˆå§‹åŒ–
        initChart();
        loadData();

        // å“åº”çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', () => {
            if (chart) {
                chart.applyOptions({
                    width: document.getElementById('chart').clientWidth,
                    height: document.getElementById('chart').clientHeight
                });
            }
        });
    </script>
</body>
</html>
